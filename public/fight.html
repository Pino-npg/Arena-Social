<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Fight Game - Pino Collection</title>
<link rel="stylesheet" href="style.css">
<style>
  body { text-align:center; position:relative; background: url('img/Arena.png') center/cover no-repeat; }
  .player { border:1px solid #ccc; padding:10px; display:inline-block; width:220px; background:#fff; vertical-align:top; margin:10px;}
  .bar { height:20px; background:#4caf50; margin-top:5px; transition: width 0.5s; }
  .dice { height:60px; margin-top:10px; }
  .bonus { font-size:0.9em; color:#444; text-align:left; margin-top:5px; }
  #onlineCounter { position:absolute; top:10px; right:10px; font-weight:bold; color:white; font-size:1.2em; }
  #characterSelection img { width:80px; height:auto; cursor:pointer; margin:5px; border:2px solid transparent; }
  #characterSelection img.selected { border-color:gold; }
</style>
</head>
<body>

<h1>Fight Game - Pino Collection</h1>
<div id="onlineCounter">Online: 0</div>

<div id="modeButtons">
  <button onclick="chooseMode('wallet')">Connect Wallet</button>
  <button onclick="chooseMode('demo')">Demo</button>
</div>

<div id="characterSelection"></div>

<div id="players">
  <div class="player" id="player1">
    <h2>Waiting...</h2>
    <img id="player1-img" src="img/Beast.png" alt="Player 1">
    <div class="bonus">No bonus</div>
    <p>HP: <span class="hp">20</span></p>
    <div class="bar" style="width:100%"></div>
    <img class="dice" src="img/dice1.png" alt="Dice">
  </div>
  <div class="player" id="player2">
    <h2>Waiting...</h2>
    <img id="player2-img" src="img/Beast.png" alt="Player 2">
    <div class="bonus">No bonus</div>
    <p>HP: <span class="hp">20</span></p>
    <div class="bar" style="width:100%"></div>
    <img class="dice" src="img/dice1.png" alt="Dice">
  </div>
</div>

<pre id="log"></pre>

<script>
const characters = ["Beast","Clown","Cyclope","Giant","Hero","Kongo","Pirate","Sailor","Taurus","WereWolf"];
let selectedCharacter = "Beast";
let playerIndex = null;
let playerMode = null;
let ws;

const players = [
  {name:"Player 1", hp:20, bonusHP:0, bonusDamage:0, bonusInitiative:0, stunned:false, description:[], mode:null, character:"Beast"},
  {name:"Player 2", hp:20, bonusHP:0, bonusDamage:0, bonusInitiative:0, stunned:false, description:[], mode:null, character:"Beast"}
];

// --- WebSocket ---
function connectWS(){
  ws = new WebSocket('wss://TUO_APP_RENDER.onrender.com');
  ws.onopen = () => console.log("‚úÖ Connesso al server WebSocket");
  ws.onmessage = (event) => {
    const msg = JSON.parse(event.data);
    if(msg.type==="online") document.getElementById('onlineCounter').innerText = 'Online: '+msg.count;
    if(msg.type==="assign" && playerIndex===null){
      playerIndex = msg.index;
      console.log("Sei il player", playerIndex+1);
    }
    if(msg.type==="start") startBattle();
    if(msg.type==="update") updateFromServer(msg);
  };
}

// --- Modalit√† ---
function chooseMode(mode){
  playerMode = mode;
  if(!ws) connectWS();
  ws.send(JSON.stringify({type:"join", mode:mode, character:selectedCharacter}));
}

// --- Selezione personaggio ---
const charDiv = document.getElementById("characterSelection");
characters.forEach(c=>{
  const img = document.createElement("img");
  img.src=`img/${c}.png`;
  img.title=c;
  img.onclick=()=>{ selectedCharacter=c; document.querySelectorAll("#characterSelection img").forEach(i=>i.classList.remove("selected")); img.classList.add("selected"); };
  if(c==="Beast") img.classList.add("selected");
  charDiv.appendChild(img);
});

// --- BONUS demo ---
function getBonus(tokens){
  let bonus={hp:0,damage:0,initiative:0,description:[]};
  if(playerMode==='wallet' && tokens){
    tokens.forEach(t=>{
      if(t.collection==="PINO" && characters.includes(t.name)){
        bonus.hp+=2; bonus.damage+=1; bonus.initiative+=1; bonus.description.push("+2 HP (Special)","+1 Damage","+1 Initiative");
      } else if(t.collection==="PINO"){ bonus.hp+=2; bonus.damage+=1; bonus.description.push("+2 HP (PINO)","+1 Damage"); }
      else if(t.collection==="YUMI"){ bonus.hp+=2; bonus.description.push("+2 HP (YUMI)"); }
    });
  }
  return bonus;
}

// --- UI ---
function updateUI(){
  players.forEach((p,i)=>{
    document.querySelectorAll('.hp')[i].innerText=p.hp;
    document.querySelectorAll('.bar')[i].style.width=(p.hp/(20+p.bonusHP)*100)+'%';
    document.getElementById(`player${i+1}-img`).src=`img/${p.character}${p.hp<=15?15:p.hp<=10?10:p.hp<=5?5:0}.png`;
  });
}

function rollDice(){ return Math.floor(Math.random()*8)+1; }
function showDice(playerIndex,value){ document.querySelectorAll('.dice')[playerIndex].src=`img/dice${value}.png`; }

// --- Sincronizzazione --- 
function updateFromServer(msg){
  if(msg.hp!==undefined) { players[msg.player].hp=msg.hp; updateUI(); }
}

// --- BATTLE ---
async function startBattle(){
  const logEl=document.getElementById('log');
  logEl.textContent='';
  players.forEach(p=>p.stunned=false);
  updateUI();

  const init1=rollDice()+players[0].bonusInitiative;
  const init2=rollDice()+players[1].bonusInitiative;
  let attacker=init1>=init2?players[0]:players[1];
  let defender=attacker===players[0]?players[1]:players[0];

  logEl.textContent+=`üåÄ Initiative: ${attacker.name} starts first!\n\n`;
  let turn=1;
  while(players[0].hp>0 && players[1].hp>0){
    await new Promise(r=>setTimeout(r,2000));
    const roll=rollDice();
    showDice(attacker===players[0]?0:1,roll);

    let dmg=roll+attacker.bonusDamage;
    if(attacker.stunned){ dmg=Math.max(0,dmg-1); logEl.textContent+=`üòµ ${attacker.name} is stunned and deals -1 damage!\n`; attacker.stunned=false; }

    if(dmg>=8){ logEl.textContent+=`üí• CRITICAL by ${attacker.name}!\n`; defender.stunned=true; }

    defender.hp-=dmg; if(defender.hp<0)defender.hp=0;
    updateUI();
    ws.send(JSON.stringify({type:"update", player:players.indexOf(defender), hp:defender.hp}));

    logEl.textContent+=`üî¥ Turn ${turn}: ${attacker.name} deals ${dmg} damage to ${defender.name}. Remaining HP: ${defender.hp}\n\n`;
    if(defender.hp<=0) break;
    [attacker,defender]=[defender,attacker];
    turn++;
  }

  await new Promise(r=>setTimeout(r,2000));
  const winner=players[0].hp>0?players[0].name:players[1].name;
  logEl.textContent+=`üèÜ Winner: ${winner}!\n`;
}
</script>
</body>
</html>