<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Fight Game - Pino Collection</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="overlay"></div>

<h1>Fight Game - Pino Collection</h1>
<div id="onlineCounter">Online: 0</div>

<!-- Mode Selection -->
<div class="modeButtons">
  <h3>Select Mode:</h3>
  <button id="walletBtn" disabled>Connect Wallet</button>
  <button id="demoBtn" disabled>Demo</button>
</div>

<!-- Character Selection -->
<div class="characters-selection">
  <img src="img/Beast.png" data-name="Beast">
  <img src="img/Clown.png" data-name="Clown">
  <img src="img/Cyclope.png" data-name="Cyclope">
  <img src="img/Giant.png" data-name="Giant">
  <img src="img/Hero.png" data-name="Hero">
  <img src="img/Kongo.png" data-name="Kongo">
  <img src="img/Pirate.png" data-name="Pirate">
  <img src="img/Sailor.png" data-name="Sailor">
  <img src="img/Taurus.png" data-name="Taurus">
  <img src="img/WereWolf.png" data-name="WereWolf">
</div>

<!-- Players Display -->
<div id="players">
  <div class="player" id="player1">
    <h2>Waiting...</h2>
    <div class="bonus">No bonus</div>
    <p>HP: <span class="hp">20</span></p>
    <div class="bar" style="width:100%"></div>
    <img class="character" src="img/Beast.png" alt="Player 1 Character">
    <img class="dice" src="img/dice1.png" alt="Dice">
  </div>
  <div class="player" id="player2">
    <h2>Waiting...</h2>
    <div class="bonus">No bonus</div>
    <p>HP: <span class="hp">20</span></p>
    <div class="bar" style="width:100%"></div>
    <img class="character" src="img/Beast.png" alt="Player 2 Character">
    <img class="dice" src="img/dice1.png" alt="Dice">
  </div>
</div>

<button id="startBattle" disabled>Start Battle</button>
<pre id="log"></pre>

<script>
const ws = new WebSocket(`${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.host}`);
const players = [
  {name:"Player 1", hp:20, bonusHP:0, bonusDamage:0, bonusInitiative:0, character:"Beast"},
  {name:"Player 2", hp:20, bonusHP:0, bonusDamage:0, bonusInitiative:0, character:"Beast"}
];
let playerIndex = null; // 0 o 1
let ready = false;

// --- Enable buttons on WebSocket open ---
ws.onopen = () => {
  document.getElementById('walletBtn').disabled = false;
  document.getElementById('demoBtn').disabled = false;
};

// --- Update online counter ---
ws.onmessage = (event) => {
  const msg = JSON.parse(event.data);
  if(msg.type === 'online'){
    document.getElementById('onlineCounter').innerText = 'Online: ' + msg.count;
  } else if(msg.type === 'join'){
    assignPlayer(msg.index, msg.mode);
  } else if(msg.type === 'character'){
    updateCharacterUI(msg.index);
  } else if(msg.type === 'start'){
    if(playerIndex !== null) startBattle();
  }
};

// --- Assign player and mode ---
function assignPlayer(index, mode){
  playerIndex = index;
  players[playerIndex].mode = mode;
  document.getElementById('player'+(index+1)).querySelector('h2').innerText = players[index].name;
  document.getElementById('startBattle').disabled = false;
}

// --- Choose mode ---
document.getElementById('walletBtn').onclick = () => {
  ws.send(JSON.stringify({type:'join', mode:'wallet'}));
};
document.getElementById('demoBtn').onclick = () => {
  ws.send(JSON.stringify({type:'join', mode:'demo'}));
};

// --- Character Selection ---
const characterImages = document.querySelectorAll('.characters-selection img');
characterImages.forEach(img => {
  img.addEventListener('click', () => {
    characterImages.forEach(i => i.classList.remove('selected'));
    img.classList.add('selected');
    if(playerIndex !== null){
      players[playerIndex].character = img.dataset.name;
      updateCharacterUI(playerIndex);
      ws.send(JSON.stringify({type:'character', index:playerIndex, character:img.dataset.name}));
    }
  });
});

// --- Update character image according to HP ---
function updateCharacterUI(index){
  const player = players[index];
  const el = document.getElementById('player'+(index+1)).querySelector('img.character');
  let suffix = '';
  if(player.hp <= 0) suffix = '0';
  else if(player.hp <= 5) suffix = '5';
  else if(player.hp <= 10) suffix = '10';
  else if(player.hp <= 15) suffix = '15';
  el.src = `img/${player.character}${suffix}.png`;
  document.getElementById('player'+(index+1)).querySelector('.hp').innerText = player.hp;
  document.getElementById('player'+(index+1)).querySelector('.bar').style.width = (player.hp/(20+player.bonusHP)*100)+'%';
}

// --- Start battle ---
document.getElementById('startBattle').onclick = () => {
  ws.send(JSON.stringify({type:'start'}));
};

async function startBattle(){
  const logEl = document.getElementById('log');
  logEl.textContent = '';
  let [attacker, defender] = players[0].hp >= players[1].hp ? [players[0], players[1]] : [players[1], players[0]];
  let turn = 1;
  while(players[0].hp > 0 && players[1].hp > 0){
    await new Promise(r => setTimeout(r,2000));
    const roll = Math.floor(Math.random()*8)+1;
    document.querySelectorAll('.dice')[attacker===players[0]?0:1].src = `img/dice${roll}.png`;
    let dmg = roll + attacker.bonusDamage;
    defender.hp -= dmg;
    if(defender.hp<0) defender.hp=0;
    updateCharacterUI(0);
    updateCharacterUI(1);
    logEl.textContent += `üî¥ Turn ${turn}: ${attacker.name} deals ${dmg} damage to ${defender.name}. Remaining HP: ${defender.hp}\n`;
    if(defender.hp <= 0) break;
    [attacker, defender] = [defender, attacker];
    turn++;
  }
  const winner = players[0].hp>0 ? players[0].name : players[1].name;
  logEl.textContent += `üèÜ Winner: ${winner}!\n`;
}
</script>
</body>
</html>